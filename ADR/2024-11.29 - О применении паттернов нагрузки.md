**Дата:** 29 ноября 2024 г.

**Статус:** Предложено

**Контекст:**

По нефункциональным требованиям нам необходимо обеспечить высокую доступность и отказоустойчивость сервиса стриминга музыки. А так же нам необходимо эффективно управлять постоянно увеличивающимся объемом данных пользователей. Еще нам требуется быстрый доступ к данным пользователей из разных регионов. Единственный сервер баз данных не справится, поэтому требуется оптимизация для достижения поставленных задач.

**Рассмотренные варианты:**

1. **Кэширование данных:** Позволяет хранить часто запрашиваемые данные в памяти для быстрого доступа.
2. **Балансировка нагрузки (Load Balancing):** Распределение входящих запросов между несколькими серверами для повышения доступности и производительности.
3. **Очереди сообщений (Message Queues):** Увеличение производительности за счёт разделения данных на множество серверов. Такой способ предполагает увеличение производительности без снижения отказоустойчивости.
4. **Репликация:** Копирование данных между серверами.
5. **CDN (Content Delivery Network):** Использование распределенной сети серверов для доставки контента пользователям.

**Решение:**

Для того, чтобы снизить нагрузку на сервера сервиса необходима региональная сегментация(sharding). Она позволяет распределять данные по разным регионам тем самым повышая производительность для пользователей в разных регионах России и сокращая время отклика. Таким образом у нас снижается нагрузка на основной сервер.
Реализация региональной сегментации базы данных PostgreSQL включает в себя следующие компоненты:

- _Шардирование_ (Распределяя операции записи между несколькими шардами, система может обрабатывать больше одновременных записей, что приводит к повышению эффективности и надежности базы данных.)
- _Репликация_ (Гарантирует сохранение согласованного резервного копирования в случае аварии, аппаратной катастрофы или нарушения системы, которое может поставить под угрозу данные.)
- _Балансировка нагрузки_ (Позволяет масштабировать систему горизонтально и повышает доступность системы)
- _Кэширование данных_ (Ускоряет время ответа системы и снижает нагрузку на базу данных, что позволяет системе более эффективно обрабатывать большое количество запросов)

Предлагается на каждый крупный регион России расположить по одному серверу до необходимости масштабирования:

- Москва
- Санкт-Петербург
- Калужская область
- Татарстан (Казань)
- Новосибирская область (Новосибирск)
- Свердловская область (Екатеринбург)
- Краснодарский край (Краснодар)
- Челябинская область (Челябинск)
- Ростовская область (Ростов-на-Дону)
- Приморский край (Владивосток)
- Республика Саха (Якутск)
- Чукотский автономный округ (Анадырь)

**Обоснование:**

- За счет сокращения времени отклика повысилась производительность для пользователей из разных регионов.
- Повышается отказоустойчивость за счет репликации и балансировки нагрузки.
- Появилась возможность расширять систему в ответ на возросшую нагрузку.

**Последствия:**

- Сложность архитектуры и необходимость дополнительной настройки и мониторинга.
- Потенциальные проблемы с согласованностью данных в разных регионах требуют дополнительных механизмов.
